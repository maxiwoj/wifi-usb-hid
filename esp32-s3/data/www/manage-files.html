<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Management - WiFi USB HID</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>File Management</h1>
        <p style="color: #6b7280; margin-top: 5px;">Upload, download, and manage LittleFS filesystem files</p>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button class="btn btn-info" onclick="location.href='/'">Back to Home</button>
      </div>
    </div>

    <div class="card">
      <h2>Filesystem Status</h2>
      <div id="fsStatus" style="min-height: 50px;">
        <p style="color: #6b7280;">Loading...</p>
      </div>
    </div>

    <div class="card">
      <h2>Upload / Create</h2>
      <div style="display: grid; gap: 15px;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Upload File to Current Directory:</label>
          <div style="display: flex; gap: 10px;">
            <input type="file" id="fileInput" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;">
            <button class="btn btn-success" onclick="uploadFile()" id="uploadBtn">Upload</button>
          </div>
          <p style="font-size: 12px; color: #6b7280; margin: 5px 0 0 0;">
            Tip: To update the main page, upload a new index.html file to root or /www
          </p>
        </div>
        <div style="border-top: 1px solid #e5e7eb; padding-top: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Create New Directory:</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="dirName" placeholder="Directory name" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;">
            <button class="btn btn-primary" onclick="createDirectory()">Create Folder</button>
          </div>
        </div>
        <div id="uploadProgress" style="display: none; padding: 10px; background: #f3f4f6; border-radius: 8px; text-align: center; font-weight: 600;">
          Processing...
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0;">Files</h2>
        <div id="pathDisplay" style="font-family: monospace; background: #f3f4f6; padding: 5px 12px; border-radius: 6px; color: #4b5563;">/</div>
      </div>
      <div id="filesList" style="min-height: 50px;">
        <p style="color: #6b7280;">Loading...</p>
      </div>
    </div>

    <div class="card">
      <h2>Activity Log</h2>
      <div class="activity-log" id="activityLog"></div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    let currentPath = '/';

    function loadFilesystemStatus() {
      fetch('/api/files?path=' + encodeURIComponent(currentPath))
        .then(response => response.json())
        .then(data => {
          const fsDiv = document.getElementById('fsStatus');
          const fs = data.filesystem;
          const usedPercent = Math.round((fs.used / fs.total) * 100);

          const totalMB = (fs.total / 1048576).toFixed(2);
          const usedMB = (fs.used / 1048576).toFixed(2);
          const freeMB = (fs.free / 1048576).toFixed(2);

          fsDiv.innerHTML = `
            <div style="display: grid; gap: 10px;">
              <div style="display: flex; justify-content: space-between;">
                <span><strong>Total:</strong> ${totalMB} MB</span>
                <span><strong>Used:</strong> ${usedMB} MB (${usedPercent}%)</span>
                <span><strong>Free:</strong> ${freeMB} MB</span>
              </div>
              <div style="width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                <div style="width: ${usedPercent}%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #6366f1); transition: width 0.3s;"></div>
              </div>
              ${usedPercent > 90 ? '<p style="color: #ef4444; font-weight: 600; margin-top: 5px;">Warning: Low storage space!</p>' : ''}
            </div>
          `;

          // Update path display
          currentPath = data.path || '/';
          document.getElementById('pathDisplay').textContent = currentPath;

          // Also load files list
          loadFilesList(data.files);
        })
        .catch(error => {
          document.getElementById('fsStatus').innerHTML = '<p style="color: #ef4444;">Error loading filesystem info: ' + error + '</p>';
          log('Error loading filesystem info: ' + error);
        });
    }

    function loadFilesList(files) {
      const filesDiv = document.getElementById('filesList');

      let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
      html += '<thead><tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">';
      html += '<th style="padding: 10px; font-weight: 600;">Name</th>';
      html += '<th style="padding: 10px; font-weight: 600;">Size</th>';
      html += '<th style="padding: 10px; font-weight: 600;">Actions</th>';
      html += '</tr></thead><tbody>';

      // Add "Up" directory link if not in root
      if (currentPath !== '/') {
        html += '<tr style="border-bottom: 1px solid #e5e7eb; background: #f9fafb;">';
        html += '<td style="padding: 10px; cursor: pointer;" colspan="3" onclick="goUp()">';
        html += '<span style="color: #6366f1; font-weight: 600;">üìÅ .. (Up Directory)</span>';
        html += '</td></tr>';
      }

      if (!files || files.length === 0) {
        if (currentPath === '/') {
           filesDiv.innerHTML = html + '</tbody></table><p style="color: #6b7280; font-style: italic; padding: 10px;">No files found.</p></div>';
        } else {
           filesDiv.innerHTML = html + '</tbody></table><p style="color: #6b7280; font-style: italic; padding: 10px;">Directory is empty.</p></div>';
        }
        return;
      }

      // Sort: Directories first, then alphabetically
      files.sort((a, b) => {
        if (a.is_dir && !b.is_dir) return -1;
        if (!a.is_dir && b.is_dir) return 1;
        return a.name.localeCompare(b.name);
      });

      files.forEach(file => {
        // Clean name for display (remove full path if present)
        let displayName = file.name;
        if (displayName.startsWith(currentPath)) {
            displayName = displayName.substring(currentPath.length);
            if (displayName.startsWith('/')) displayName = displayName.substring(1);
        }
        if (displayName === '') displayName = file.name;

        const isCore = file.name === '/index.html' || file.name === '/style.css' || file.name === '/script.js';
        const sizeKB = (file.size / 1024).toFixed(2);

        html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
        html += '<td style="padding: 10px;">';
        
        if (file.is_dir) {
          html += '<span style="cursor: pointer; font-weight: 600; color: #4f46e5;" onclick="enterDirectory(\'' + file.name + '\')">üìÅ ' + displayName + '</span>';
        } else {
          html += '<span style="font-family: monospace;">üìÑ ' + displayName + '</span>';
        }
        
        if (isCore) {
          html += ' <span style="font-size: 11px; padding: 2px 6px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-weight: 600;">CORE</span>';
        }
        html += '</td>';
        html += '<td style="padding: 10px; color: #6b7280;">' + (file.is_dir ? '--' : sizeKB + ' KB') + '</td>';
        html += '<td style="padding: 10px;"><div style="display: flex; gap: 5px;">';
        if (!file.is_dir) {
          html += '<button class="btn btn-info" style="padding: 5px 15px; font-size: 12px;" onclick="downloadFile(\'' + file.name + '\')">Download</button>';
        }
        html += '<button class="btn btn-danger" style="padding: 5px 15px; font-size: 12px;" onclick="deleteFile(\'' + file.name + '\', ' + file.is_dir + ')">Delete</button>';
        html += '</div></td>';
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      filesDiv.innerHTML = html;
    }

    function goUp() {
      if (currentPath === '/') return;
      let parts = currentPath.split('/');
      parts.pop();
      if (parts[parts.length-1] === '') parts.pop();
      currentPath = parts.join('/') || '/';
      loadFilesystemStatus();
    }

    function enterDirectory(path) {
      currentPath = path;
      loadFilesystemStatus();
    }

    function createDirectory() {
      const nameInput = document.getElementById('dirName');
      const name = nameInput.value.trim();
      if (!name) return;
      
      const fullPath = (currentPath.endsWith('/') ? currentPath : currentPath + '/') + name;
      
      const formData = new URLSearchParams();
      formData.append('path', fullPath);

      fetch('/api/files/create_dir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'ok') {
          log('Directory created: ' + fullPath);
          nameInput.value = '';
          loadFilesystemStatus();
        } else {
          log('Error: ' + data.message);
        }
      })
      .catch(error => log('Error: ' + error));
    }

    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        log('Error: Please select a file to upload');
        return;
      }

      const uploadBtn = document.getElementById('uploadBtn');
      const uploadProgress = document.getElementById('uploadProgress');

      uploadBtn.disabled = true;
      uploadProgress.style.display = 'block';
      uploadProgress.textContent = 'Uploading ' + file.name + '...';

      const formData = new FormData();
      formData.append('file', file);

      fetch('/api/files/upload?path=' + encodeURIComponent(currentPath), {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok') {
            log('File uploaded successfully: ' + file.name);
            fileInput.value = '';
            loadFilesystemStatus();
          } else {
            log('Error: ' + (data.message || 'Upload failed'));
          }
        })
        .catch(error => {
          log('Error uploading file: ' + error);
        })
        .finally(() => {
          uploadBtn.disabled = false;
          uploadProgress.style.display = 'none';
        });
    }

    function deleteFile(filename, isDir) {
      const type = isDir ? 'directory' : 'file';
      if (!confirm('Are you sure you want to delete this ' + type + ': ' + filename + '? ' + (isDir ? '(Must be empty)' : ''))) {
        return;
      }

      const formData = new URLSearchParams();
      formData.append('name', filename);

      fetch('/api/files/delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok') {
            log('Deleted: ' + filename);
            loadFilesystemStatus();
          } else {
            log('Error: ' + (data.message || 'Delete failed'));
          }
        })
        .catch(error => {
          log('Error deleting item: ' + error);
        });
    }

    function downloadFile(filename) {
      window.location.href = '/api/files/download?name=' + encodeURIComponent(filename);
      log('Downloading: ' + filename);
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadFilesystemStatus();
    });
  </script>
</body>
</html>
