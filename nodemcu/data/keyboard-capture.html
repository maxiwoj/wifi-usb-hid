<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keyboard Capture - WiFi USB HID</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .capture-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: #ef4444;
      color: white;
      border-radius: 30px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5);
      z-index: 1000;
      display: none;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .capture-indicator.active {
      display: block;
    }

    .key-history {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.8;
    }

    .key-event {
      padding: 5px 10px;
      margin: 3px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .key-event.keydown {
      background: #dbeafe;
      border-left: 3px solid #3b82f6;
    }

    .key-event.keyup {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
    }

    .key-event-type {
      font-weight: bold;
      min-width: 70px;
      color: #667eea;
    }

    .key-event-key {
      background: white;
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-weight: bold;
    }

    .key-event-modifiers {
      color: #6b7280;
      font-size: 11px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .instructions {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #1e40af;
    }

    .instructions h3 {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .instructions ul {
      margin-left: 20px;
      line-height: 1.8;
    }

    .warning-box {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="capture-indicator" id="captureIndicator">
    üéπ CAPTURING KEYBOARD
  </div>

  <div class="container">
    <div class="header">
      <div>
        <h1>üéπ Keyboard Capture</h1>
        <p style="color: #6b7280; font-size: 14px; margin-top: 5px;">Real-time keyboard event forwarding</p>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button class="btn btn-info" onclick="location.href='/'">‚Üê Back to Main</button>
      </div>
    </div>

    <div class="card">
      <h2>Keyboard Capture Control</h2>

      <div class="warning-box">
        <strong>‚ö†Ô∏è Important:</strong> When keyboard capture is active, all your keyboard input will be forwarded to the connected computer. Some browser shortcuts may be captured and not work as expected.
      </div>

      <div class="jiggler-control" style="margin-bottom: 15px;">
        <div class="toggle-switch" id="captureToggle" onclick="toggleCapture()"></div>
        <span id="captureStatus">Disabled</span>
      </div>

      <div class="instructions">
        <h3>üìñ How to use:</h3>
        <ul>
          <li><strong>Toggle ON</strong> to start capturing keyboard events</li>
          <li>All keyboard input will be forwarded to the connected computer</li>
          <li>View real-time event history below</li>
          <li><strong>Toggle OFF</strong> to stop capturing</li>
          <li>Press <strong>ESC</strong> key to quickly disable capture</li>
        </ul>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statKeyDown">0</div>
          <div class="stat-label">Key Down</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statKeyUp">0</div>
          <div class="stat-label">Key Up</div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn btn-warning" onclick="clearHistory()">Clear History</button>
        <button class="btn btn-danger" onclick="releaseAllKeys()">Release All Keys</button>
      </div>
    </div>

    <div class="card">
      <h2>Event History</h2>
      <div class="key-history" id="keyHistory">
        <p style="color: #6b7280; text-align: center; padding: 20px;">No events captured yet. Enable capture to start.</p>
      </div>
    </div>
  </div>

  <script>
    let captureEnabled = false;
    let pressedKeys = new Set();
    let eventCount = { total: 0, keydown: 0, keyup: 0 };
    let eventHistory = [];
    const MAX_HISTORY = 100;

    // Key mapping for special keys
    const keyMap = {
      'Control': 'CTRL',
      'Shift': 'SHIFT',
      'Alt': 'ALT',
      'Meta': 'GUI',
      'Enter': 'ENTER',
      'Escape': 'ESC',
      'Tab': 'TAB',
      'Backspace': 'BACKSPACE',
      'Delete': 'DELETE',
      'ArrowUp': 'UP',
      'ArrowDown': 'DOWN',
      'ArrowLeft': 'LEFT',
      'ArrowRight': 'RIGHT',
      'Home': 'HOME',
      'End': 'END',
      'PageUp': 'PAGEUP',
      'PageDown': 'PAGEDOWN',
      'Insert': 'INSERT',
      'CapsLock': 'CAPSLOCK',
      ' ': 'SPACE'
    };

    // Function keys
    for (let i = 1; i <= 12; i++) {
      keyMap[`F${i}`] = `F${i}`;
    }

    function toggleCapture() {
      captureEnabled = !captureEnabled;
      const toggle = document.getElementById('captureToggle');
      const status = document.getElementById('captureStatus');
      const indicator = document.getElementById('captureIndicator');

      if (captureEnabled) {
        toggle.classList.add('active');
        status.textContent = 'Active';
        status.style.color = '#10b981';
        indicator.classList.add('active');
        addLog('Keyboard capture ENABLED', 'info');

        // Focus the window to ensure we receive keyboard events
        window.focus();
      } else {
        toggle.classList.remove('active');
        status.textContent = 'Disabled';
        status.style.color = '#6b7280';
        indicator.classList.remove('active');
        addLog('Keyboard capture DISABLED', 'info');

        // Release all pressed keys when disabling
        releaseAllKeys();
      }
    }

    function getKeyCommand(key) {
      // Check if it's a special key
      if (keyMap[key]) {
        return keyMap[key];
      }

      // For regular characters, return as-is
      if (key.length === 1) {
        return key;
      }

      return null;
    }

    function sendCommand(cmd) {
      fetch('/api/command?cmd=' + encodeURIComponent(cmd), {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + btoa('admin:WiFi_HID!826')
        }
      })
      .then(response => response.json())
      .catch(error => console.error('Error:', error));
    }

    function handleKeyDown(event) {
      if (!captureEnabled) return;

      const key = event.key;
      const keyCommand = getKeyCommand(key);

      if (!keyCommand) return;

      // Special handling: ESC key disables capture
      if (key === 'Escape') {
        toggleCapture();
        return;
      }

      // Prevent duplicate events for held keys
      const keyId = `${keyCommand}`;
      if (pressedKeys.has(keyId)) return;

      pressedKeys.add(keyId);

      // Prevent default browser behavior
      event.preventDefault();
      event.stopPropagation();

      // Send key press command
      sendCommand(`KEY_PRESS:${keyCommand}`);

      // Log the event
      const modifiers = [];
      if (event.ctrlKey && key !== 'Control') modifiers.push('Ctrl');
      if (event.shiftKey && key !== 'Shift') modifiers.push('Shift');
      if (event.altKey && key !== 'Alt') modifiers.push('Alt');
      if (event.metaKey && key !== 'Meta') modifiers.push('Meta');

      addEventToHistory({
        type: 'keydown',
        key: keyCommand,
        modifiers: modifiers,
        timestamp: new Date()
      });

      updateStats('keydown');
    }

    function handleKeyUp(event) {
      if (!captureEnabled) return;

      const key = event.key;
      const keyCommand = getKeyCommand(key);

      if (!keyCommand) return;

      const keyId = `${keyCommand}`;
      pressedKeys.delete(keyId);

      // Prevent default browser behavior
      event.preventDefault();
      event.stopPropagation();

      // Send key release command
      sendCommand(`KEY_RELEASE:${keyCommand}`);

      // Log the event
      const modifiers = [];
      if (event.ctrlKey && key !== 'Control') modifiers.push('Ctrl');
      if (event.shiftKey && key !== 'Shift') modifiers.push('Shift');
      if (event.altKey && key !== 'Alt') modifiers.push('Alt');
      if (event.metaKey && key !== 'Meta') modifiers.push('Meta');

      addEventToHistory({
        type: 'keyup',
        key: keyCommand,
        modifiers: modifiers,
        timestamp: new Date()
      });

      updateStats('keyup');
    }

    function addEventToHistory(event) {
      eventHistory.unshift(event);
      if (eventHistory.length > MAX_HISTORY) {
        eventHistory.pop();
      }
      renderHistory();
    }

    function renderHistory() {
      const historyDiv = document.getElementById('keyHistory');

      if (eventHistory.length === 0) {
        historyDiv.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No events captured yet. Enable capture to start.</p>';
        return;
      }

      historyDiv.innerHTML = eventHistory.map(event => {
        const time = event.timestamp.toLocaleTimeString();
        const modStr = event.modifiers.length > 0 ? `<span class="key-event-modifiers">(${event.modifiers.join('+')})</span>` : '';

        return `<div class="key-event ${event.type}">
          <span class="key-event-type">${event.type === 'keydown' ? '‚¨á DOWN' : '‚¨Ü UP'}</span>
          <span class="key-event-key">${event.key}</span>
          ${modStr}
          <span style="margin-left: auto; color: #9ca3af; font-size: 11px;">${time}</span>
        </div>`;
      }).join('');
    }

    function updateStats(type) {
      eventCount.total++;
      if (type === 'keydown') eventCount.keydown++;
      if (type === 'keyup') eventCount.keyup++;

      document.getElementById('statTotal').textContent = eventCount.total;
      document.getElementById('statKeyDown').textContent = eventCount.keydown;
      document.getElementById('statKeyUp').textContent = eventCount.keyup;
    }

    function clearHistory() {
      if (confirm('Clear event history?')) {
        eventHistory = [];
        eventCount = { total: 0, keydown: 0, keyup: 0 };
        renderHistory();
        updateStats();
        addLog('History cleared', 'info');
      }
    }

    function releaseAllKeys() {
      sendCommand('KEY_RELEASE_ALL');
      pressedKeys.clear();
      addLog('All keys released', 'info');
    }

    function addLog(message, type = 'info') {
      // Optional: could add a separate activity log if needed
      console.log(`[${type}] ${message}`);
    }

    // Add event listeners
    document.addEventListener('keydown', handleKeyDown, true);
    document.addEventListener('keyup', handleKeyUp, true);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (captureEnabled) {
        releaseAllKeys();
      }
    });

    // Release all keys when window loses focus
    window.addEventListener('blur', () => {
      if (captureEnabled && pressedKeys.size > 0) {
        releaseAllKeys();
      }
    });
  </script>
</body>
</html>
