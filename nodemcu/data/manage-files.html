<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Management - WiFi USB HID</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>File Management</h1>
        <p style="color: #6b7280; margin-top: 5px;">Upload, download, and manage LittleFS filesystem files</p>
      </div>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button class="btn btn-info" onclick="location.href='/'">Back to Home</button>
      </div>
    </div>

    <div class="card">
      <h2>Filesystem Status</h2>
      <div id="fsStatus" style="min-height: 50px;">
        <p style="color: #6b7280;">Loading...</p>
      </div>
    </div>

    <div class="card">
      <h2>Upload File</h2>
      <div style="display: grid; gap: 10px;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Select File:</label>
          <input type="file" id="fileInput" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit;">
          <p style="font-size: 12px; color: #6b7280; margin: 5px 0 0 0;">
            Tip: To update the main page, upload a new index.html file
          </p>
        </div>
        <button class="btn btn-success" onclick="uploadFile()" id="uploadBtn">Upload File</button>
        <div id="uploadProgress" style="display: none; padding: 10px; background: #f3f4f6; border-radius: 8px; text-align: center; font-weight: 600;">
          Uploading...
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Files</h2>
      <div id="filesList" style="min-height: 50px;">
        <p style="color: #6b7280;">Loading...</p>
      </div>
    </div>

    <div class="card">
      <h2>Activity Log</h2>
      <div class="activity-log" id="activityLog"></div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    function loadFilesystemStatus() {
      fetch('/api/files')
        .then(response => response.json())
        .then(data => {
          const fsDiv = document.getElementById('fsStatus');
          const fs = data.filesystem;
          const usedPercent = Math.round((fs.used / fs.total) * 100);

          const totalMB = (fs.total / 1048576).toFixed(2);
          const usedMB = (fs.used / 1048576).toFixed(2);
          const freeMB = (fs.free / 1048576).toFixed(2);

          fsDiv.innerHTML = `
            <div style="display: grid; gap: 10px;">
              <div style="display: flex; justify-content: space-between;">
                <span><strong>Total:</strong> ${totalMB} MB</span>
                <span><strong>Used:</strong> ${usedMB} MB (${usedPercent}%)</span>
                <span><strong>Free:</strong> ${freeMB} MB</span>
              </div>
              <div style="width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                <div style="width: ${usedPercent}%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #6366f1); transition: width 0.3s;"></div>
              </div>
              ${usedPercent > 90 ? '<p style="color: #ef4444; font-weight: 600; margin-top: 5px;">Warning: Low storage space!</p>' : ''}
            </div>
          `;

          // Also load files list
          loadFilesList(data.files);
        })
        .catch(error => {
          document.getElementById('fsStatus').innerHTML = '<p style="color: #ef4444;">Error loading filesystem info: ' + error + '</p>';
          log('Error loading filesystem info: ' + error);
        });
    }

    function loadFilesList(files) {
      const filesDiv = document.getElementById('filesList');

      if (!files || files.length === 0) {
        filesDiv.innerHTML = '<p style="color: #6b7280; font-style: italic;">No files found.</p>';
        return;
      }

      // Sort files alphabetically
      files.sort((a, b) => a.name.localeCompare(b.name));

      let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
      html += '<thead><tr style="border-bottom: 2px solid #e5e7eb; text-align: left;">';
      html += '<th style="padding: 10px; font-weight: 600;">Filename</th>';
      html += '<th style="padding: 10px; font-weight: 600;">Size</th>';
      html += '<th style="padding: 10px; font-weight: 600;">Actions</th>';
      html += '</tr></thead><tbody>';

      files.forEach(file => {
        const isCore = file.name === '/index.html' || file.name === '/style.css' || file.name === '/script.js';
        const sizeKB = (file.size / 1024).toFixed(2);

        html += '<tr style="border-bottom: 1px solid #e5e7eb;">';
        html += '<td style="padding: 10px;">';
        html += '<span style="font-family: monospace;">' + file.name + '</span>';
        if (isCore) {
          html += ' <span style="font-size: 11px; padding: 2px 6px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-weight: 600;">CORE</span>';
        }
        html += '</td>';
        html += '<td style="padding: 10px; color: #6b7280;">' + sizeKB + ' KB</td>';
        html += '<td style="padding: 10px;"><div style="display: flex; gap: 5px;">';
        html += '<button class="btn btn-info" style="padding: 5px 15px; font-size: 12px;" onclick="downloadFile(\'' + file.name + '\')">Download</button>';
        html += '<button class="btn btn-danger" style="padding: 5px 15px; font-size: 12px;" onclick="deleteFile(\'' + file.name + '\')">Delete</button>';
        html += '</div></td>';
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      filesDiv.innerHTML = html;
    }

    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        log('Error: Please select a file to upload');
        return;
      }

      const uploadBtn = document.getElementById('uploadBtn');
      const uploadProgress = document.getElementById('uploadProgress');

      uploadBtn.disabled = true;
      uploadProgress.style.display = 'block';
      uploadProgress.textContent = 'Uploading ' + file.name + '...';

      const formData = new FormData();
      formData.append('file', file);

      fetch('/api/files/upload', {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok') {
            log('File uploaded successfully: ' + file.name);
            fileInput.value = '';
            loadFilesystemStatus();
          } else {
            log('Error: ' + (data.message || 'Upload failed'));
          }
        })
        .catch(error => {
          log('Error uploading file: ' + error);
        })
        .finally(() => {
          uploadBtn.disabled = false;
          uploadProgress.style.display = 'none';
        });
    }

    function deleteFile(filename) {
      if (!confirm('Are you sure you want to delete ' + filename + '?')) {
        return;
      }

      const formData = new URLSearchParams();
      formData.append('name', filename);

      fetch('/api/files/delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok') {
            log('File deleted: ' + filename);
            loadFilesystemStatus();
          } else {
            log('Error: ' + (data.message || 'Delete failed'));
          }
        })
        .catch(error => {
          log('Error deleting file: ' + error);
        });
    }

    function downloadFile(filename) {
      window.location.href = '/api/files/download?name=' + encodeURIComponent(filename);
      log('Downloading: ' + filename);
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadFilesystemStatus();
    });
  </script>
</body>
</html>
